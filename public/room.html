<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>SCOUT â€“ ëŒ€ê¸°ì‹¤</title>
<link rel="stylesheet" href="style.css">

<style>
#roomBox {
  background:#222;
  padding:20px;
  max-width:420px;
  margin:0 auto;
  border-radius:15px;
  text-align:center;
  margin-top:40px;
}

.playerItem {
  background:#333;
  padding:12px;
  border-radius:10px;
  margin:10px 0;
}

.ready {
  color:#00ff99;
  font-weight:bold;
}

.notReady {
  color:#ff5555;
  font-weight:bold;
}
</style>

<script>
/* ---------------------------------------------------------
   ğŸ”¥ ì²« ì§„ì… ì‹œ nick(name)ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ enter.htmlë¡œ ë³´ë‚´ê¸°
---------------------------------------------------------*/
const query = new URLSearchParams(location.search);
const roomId = query.get("room");
const nickname = query.get("name");

// âŒ nickname ì—†ëŠ” ìƒíƒœë¡œ room.htmlì— ë“¤ì–´ì˜¨ ê²½ìš°
if (!nickname || nickname.trim() === "") {
  // enter.html ë¡œ ê°•ì œ ì´ë™
  location.href = `enter.html?room=${roomId}`;
}
</script>

</head>
<body>

<div id="roomBox">
  <h2>ğŸ´ SCOUT â€“ ëŒ€ê¸°ì‹¤</h2>

  <div style="margin-bottom:10px;">ë°© ID: <span id="roomId"></span></div>

  <button id="copyBtn">ì´ˆëŒ€ ë§í¬ ë³µì‚¬</button>

  <h3 style="margin-top:20px;">ì°¸ì—¬ì ëª©ë¡</h3>
  <div id="playerList"></div>

  <button id="readyBtn" style="margin-top:20px;">ì¤€ë¹„</button>
  <button id="startBtn" disabled style="background:#00c853; margin-top:10px;">
    ê²Œì„ ì‹œì‘
  </button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script type="module">

const params = new URLSearchParams(location.search);
const roomId2 = params.get("room");
const nickname2 = params.get("name");

document.getElementById("roomId").innerText = roomId2;

const socket = io();
socket.emit("joinRoom", { roomId: roomId2, nickname: nickname2 });

let players = {};
let myUid = null;

/* ---------------------------------------------------------
   ë‚´ UID
---------------------------------------------------------*/
socket.on("connect", () => {
  myUid = socket.id;
});

/* ---------------------------------------------------------
   ì´ˆëŒ€ ë§í¬ ë³µì‚¬ â†’ enter.htmlë¡œ ì´ˆëŒ€
---------------------------------------------------------*/
document.getElementById("copyBtn").onclick = () => {
  const link = `${location.origin}/enter.html?room=${roomId2}`;
  navigator.clipboard.writeText(link);
  alert("ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n" + link);
};

/* ---------------------------------------------------------
   ì°¸ê°€ì ëª©ë¡ ê°±ì‹ 
---------------------------------------------------------*/
socket.on("playerListUpdate", (p) => {
  players = p;
  renderPlayers();

  const everyoneReady = Object.values(players).every(pl => pl.ready);
  const isHost = players[myUid]?.isHost === true;

  document.getElementById("startBtn").disabled = !(everyoneReady && isHost);
});

/* ---------------------------------------------------------
   ë¦¬ìŠ¤íŠ¸ ë Œë”
---------------------------------------------------------*/
function renderPlayers() {
  const box = document.getElementById("playerList");
  box.innerHTML = "";

  Object.values(players).forEach(p => {
    const div = document.createElement("div");
    div.className = "playerItem";
    
    div.innerHTML = `
      <b>${p.nickname}</b><br>
      <span class="${p.ready ? 'ready' : 'notReady'}">
        ${p.ready ? 'READY' : 'WAIT'}
      </span>
      ${p.isHost ? ' (ë°©ì¥)' : ''}
    `;
    box.appendChild(div);
  });
}

/* ---------------------------------------------------------
   READY
---------------------------------------------------------*/
document.getElementById("readyBtn").onclick = () => {
  socket.emit("playerReady", { roomId: roomId2 });
};

/* ---------------------------------------------------------
   ë°©ì¥ â†’ ê²Œì„ ì‹œì‘
---------------------------------------------------------*/
document.getElementById("startBtn").onclick = () => {
  socket.emit("forceStartGame", { roomId: roomId2 });
};

/* ---------------------------------------------------------
   ê²Œì„ ì´ë™
---------------------------------------------------------*/
socket.on("goGame", () => {
  location.href = `game.html?room=${roomId2}&name=${nickname2}`;
});

</script>
</body>
</html>
