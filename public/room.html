<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>SCOUT â€“ ëŒ€ê¸°ì‹¤</title>
<link rel="stylesheet" href="style.css">

<style>
#roomBox {
  background:#222;
  padding:20px;
  max-width:420px;
  margin:0 auto;
  border-radius:15px;
  text-align:center;
  margin-top:40px;
}

.playerItem {
  background:#333;
  padding:12px;
  border-radius:10px;
  margin:10px 0;
}

.ready {
  color:#00ff99;
  font-weight:bold;
}

.notReady {
  color:#ff5555;
  font-weight:bold;
}
</style>
</head>
<body>

<div id="roomBox">
  <h2>ğŸ´ SCOUT â€“ ëŒ€ê¸°ì‹¤</h2>

  <div style="margin-bottom:10px;">ë°© ID: <span id="roomId"></span></div>

  <button id="copyBtn">ì´ˆëŒ€ ë§í¬ ë³µì‚¬</button>

  <h3 style="margin-top:20px;">ì°¸ì—¬ì ëª©ë¡</h3>
  <div id="playerList"></div>

  <button id="readyBtn" style="margin-top:20px;">ì¤€ë¹„</button>
  <button id="startBtn" disabled style="background:#00c853; margin-top:10px;">
    ê²Œì„ ì‹œì‘
  </button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script type="module">

/* ---------------------------------------------------------
   URL íŒŒë¼ë¯¸í„° ì½ê¸°
---------------------------------------------------------*/
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
let nickname = params.get("name");

if (!roomId) {
  alert("ë°© IDê°€ ì—†ìŠµë‹ˆë‹¤.");
  location.href = "start.html";
}

document.getElementById("roomId").innerText = roomId;

/* ---------------------------------------------------------
   SOCKET.IO ì—°ê²°
---------------------------------------------------------*/
const socket = io();
socket.emit("joinRoom", { roomId, nickname });

let players = {};
let myUid = null;

/* ---------------------------------------------------------
   ë‚´ UID ë°›ê¸°
---------------------------------------------------------*/
socket.on("connect", () => {
  myUid = socket.id;
});

/* ---------------------------------------------------------
   ì´ˆëŒ€ë§í¬ ë³µì‚¬
---------------------------------------------------------*/
document.getElementById("copyBtn").onclick = () => {
  const link = `${location.origin}/enter.html?room=${roomId}`;
  navigator.clipboard.writeText(link);
  alert("ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n" + link);
};

/* ---------------------------------------------------------
   ì°¸ê°€ì ëª©ë¡ ê°±ì‹ 
---------------------------------------------------------*/
socket.on("playerListUpdate", (p) => {
  players = p;
  renderPlayers();

  const everyoneReady = Object.values(players).every(pl => pl.ready);
  const isHost = players[myUid]?.isHost === true;

  document.getElementById("startBtn").disabled = !(everyoneReady && isHost);
});

/* ---------------------------------------------------------
   ì°¸ê°€ì ëª©ë¡ ë Œë”ë§
---------------------------------------------------------*/
function renderPlayers() {
  const box = document.getElementById("playerList");
  box.innerHTML = "";

  Object.values(players).forEach(p => {
    const div = document.createElement("div");
    div.className = "playerItem";
    
    div.innerHTML = `
      <b>${p.nickname}</b><br>
      <span class="${p.ready ? 'ready' : 'notReady'}">
        ${p.ready ? 'READY' : 'WAIT'}
      </span>
      ${p.isHost ? ' (ë°©ì¥)' : ''}
    `;

    box.appendChild(div);
  });
}

/* ---------------------------------------------------------
   READY ë²„íŠ¼
---------------------------------------------------------*/
document.getElementById("readyBtn").onclick = () => {
  socket.emit("playerReady", { roomId });
};

/* ---------------------------------------------------------
   ë°©ì¥ â†’ ê²Œì„ ì‹œì‘
---------------------------------------------------------*/
document.getElementById("startBtn").onclick = () => {
  socket.emit("forceStartGame", { roomId });
};

/* ---------------------------------------------------------
   ì„œë²„ì—ì„œ ê²Œì„ ì‹œì‘ ì‹ í˜¸(goGame) ë°›ìœ¼ë©´ â†’ game.html ì´ë™
---------------------------------------------------------*/
socket.on("goGame", () => {
  location.href = `game.html?room=${roomId}&name=${nickname}`;
});

</script>
</body>
</html>

