<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>대기방</title>
<link rel="stylesheet" href="style.css" />
<script src="/socket.io/socket.io.js"></script>
</head>

<body>
<div class="center">

  <h2 id="roomTitle">ROOM</h2>

  <div id="playerList" class="playerList"></div>

  <button id="readyBtn" class="btn">READY</button>
  <button id="startBtn" class="btn" disabled>게임 시작</button>
  <button id="copyBtn" class="btn">초대링크 복사</button>
</div>

<script>
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const myName = params.get("name");

document.getElementById("roomTitle").innerText =
  `방 ID: ${roomId}`;

const socket = io();
let players = {};
let myUid = null;

socket.on("connect", () => {
  myUid = socket.id;
  socket.emit("joinRoom", { roomId, nickname: myName });
});

socket.on("playerListUpdate", (p) => {
  players = p;
  renderPlayers();

  const allReady = Object.values(players).every(pl => pl.ready);
  const isHost = players[myUid]?.isHost;
  document.getElementById("startBtn").disabled = !(allReady && isHost);
});

function renderPlayers() {
  const list = document.getElementById("playerList");
  list.innerHTML = "";

  Object.values(players).forEach(p => {
    const div = document.createElement("div");
    div.className = "playerBox";
    div.innerHTML = `
      <b>${p.nickname}</b><br>
      READY: ${p.ready}
    `;
    list.append(div);
  });
}

document.getElementById("readyBtn").onclick = () => {
  socket.emit("playerReady", { roomId });
};

document.getElementById("startBtn").onclick = () => {
  socket.emit("forceStartGame", { roomId });
};

document.getElementById("copyBtn").onclick = () => {
  const url = `${location.origin}/enter.html?room=${roomId}`;
  navigator.clipboard.writeText(url);
  alert("초대 링크 복사됨:\n" + url);
};

socket.on("goGame", () => {
  location.href = `game.html?room=${roomId}&name=${myName}`;
});
</script>
</body>
</html>
