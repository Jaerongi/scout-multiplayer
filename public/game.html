<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>게임 화면</title>
<link rel="stylesheet" href="style.css" />
<script src="/socket.io/socket.io.js"></script>
<script type="module">
import { drawScoutCard } from "./cardEngine.js";
import { getComboType, isStrongerCombo } from "./shared.js";

const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const myName = params.get("name");

if (!roomId || !myName) {
  alert("잘못된 접근");
  location.href = "start.html";
}

const socket = io();

// 게임 화면에서도 반드시 joinRoom 해야 socket이 방에 속함
socket.emit("joinRoom", { roomId, nickname: myName });

let myUid = null;
let players = {};
let myHand = [];
let tableCards = [];
let selected = new Set();
let flipState = {};
let myTurn = false;

socket.on("connect", () => {
  myUid = socket.id;
});

// ------------------- player list -------------------
const playerListDiv = document.getElementById("playerList");
const tableAreaDiv = document.getElementById("tableArea");
const handAreaDiv = document.getElementById("handArea");
const roundInfo = document.getElementById("roundInfo");
const myCountSpan = document.getElementById("myCount");

socket.on("playerListUpdate", (p) => {
  players = p;
  renderPlayers();
});

function renderPlayers() {
  playerListDiv.innerHTML = "";
  Object.values(players).forEach(p => {
    const div = document.createElement("div");
    div.className = "playerBox";
    div.innerHTML = `
      <b>${p.nickname}</b><br>
      패: ${p.handCount}장<br>
      점수: ${p.score}
    `;
    playerListDiv.append(div);
  });
}

// ------------------- round -------------------
socket.on("roundStart", ({ round, players: pl, startingPlayer }) => {
  players = pl;
  roundInfo.innerText = `라운드 ${round}`;
  tableCards = [];
  renderTable();
});

// ------------------- hand -------------------
socket.on("yourHand", (hand) => {
  myHand = hand;
  selected.clear();
  flipState = {};
  renderHand();
});

socket.on("handCountUpdate", (obj) => {
  Object.keys(obj).forEach(uid => {
    players[uid].handCount = obj[uid];
  });
  renderPlayers();
});

// ------------------- table -------------------
socket.on("tableUpdate", (cards) => {
  tableCards = cards;
  renderTable();
});

// ------------------- turn -------------------
socket.on("turnChange", (uid) => {
  myTurn = (uid === myUid);
});

// ------------------- render functions -------------------
function renderTable() {
  tableAreaDiv.innerHTML = "";
  if (tableCards.length === 0) {
    tableAreaDiv.innerHTML = "<span style='color:#aaa'>(비어있음)</span>";
    return;
  }
  tableCards.forEach(c => {
    tableAreaDiv.append(drawScoutCard(c.top, c.bottom, 90, 130));
  });
}

function renderHand() {
  handAreaDiv.innerHTML = "";
  myCountSpan.innerText = myHand.length;

  myHand.forEach((card, idx) => {
    const useBottom = (flipState[idx] === "bottom");
    const c = useBottom ? { top: card.bottom, bottom: card.top } : card;

    const wrap = document.createElement("div");
    wrap.className = "card-wrapper";

    if (selected.has(idx)) wrap.classList.add("selected");

    wrap.append(drawScoutCard(c.top, c.bottom));

    const flipBtn = document.createElement("div");
    flipBtn.className = "flip-btn";
    flipBtn.innerText = "↻";
    flipBtn.onclick = (e) => {
      e.stopPropagation();
      flipState[idx] = useBottom ? "top" : "bottom";
      renderHand();
    };
    wrap.append(flipBtn);

    wrap.onclick = () => {
      selected.has(idx) ? selected.delete(idx) : selected.add(idx);
      renderHand();
    };

    handAreaDiv.append(wrap);
  });
}

// ------------------- buttons -------------------
window.doShow = function () {
  if (!myTurn) return alert("당신의 턴이 아닙니다.");
  if (selected.size === 0) return alert("카드를 선택하세요");

  const cards = [...selected].map(i => {
    const c = myHand[i];
    return flipState[i] === "bottom"
      ? { top: c.bottom, bottom: c.top }
      : c;
  });

  if (getComboType(cards) === "invalid")
    return alert("세트/런이 아닙니다.");

  if (!isStrongerCombo(cards, tableCards))
    return alert("더 강한 족보가 아닙니다.");

  socket.emit("show", { roomId, cards });
  selected.clear();
};

window.doScout = function () {
  if (!myTurn) return alert("당신의 턴이 아닙니다.");
  if (tableCards.length !== 1)
    return alert("스카우트는 한 장일 때만 가능합니다.");

  const c = tableCards[0];
  const bottom = confirm(`스카우트 방향 선택?\n확인: bottom(${c.bottom})`);
  const chosenValue = bottom ? "bottom" : "top";

  socket.emit("scout", { roomId, chosenValue });
};

window.doPass = function () {
  if (!myTurn) return alert("당신의 턴이 아닙니다.");
  socket.emit("pass", { roomId });
};
</script>

<body>

<h2 id="roundInfo">라운드 -</h2>

<div id="playerList"></div>

<h3>테이블</h3>
<div id="tableArea"></div>

<h3>내 패 (<span id="myCount"></span>)</h3>
<div id="handArea"></div>

<div id="actionArea">
  <button onclick="doShow()">SHOW</button>
  <button onclick="doScout()">SCOUT</button>
  <button onclick="doPass()">PASS</button>
</div>

</body>
</html>
