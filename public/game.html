<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>게임 화면</title>
<link rel="stylesheet" href="style.css" />
<script src="/socket.io/socket.io.js"></script>
<script type="module">
import { drawScoutCard } from "./cardEngine.js";
import { getComboType, isStrongerCombo } from "./shared.js";

const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const myName = params.get("name");

const socket = io();

// 게임 화면에서도 방 재입장 필수
socket.emit("joinRoom", { roomId, nickname: myName });

let myUid = null;
let players = {};
let tableCards = [];
let myHand = [];
let selected = new Set();
let flipState = {};
let myTurn = false;

socket.on("connect", () => {
  myUid = socket.id;
});

// -----------------------------------
socket.on("playerListUpdate", (p) => {
  players = p;
  renderPlayers();
});

socket.on("roundStart", ({ round, players: p }) => {
  players = p;
  tableCards = [];
  document.getElementById("roundInfo").innerText = `라운드 ${round}`;
  renderPlayers();
  renderTable();
});

socket.on("yourHand", (hand) => {
  myHand = hand;
  selected.clear();
  flipState = {};
  renderHand();
});

socket.on("handCountUpdate", (obj) => {
  Object.keys(obj).forEach(uid => {
    players[uid].handCount = obj[uid];
  });
  renderPlayers();
});

socket.on("tableUpdate", (cards) => {
  tableCards = cards;
  renderTable();
});

socket.on("turnChange", (uid) => {
  myTurn = (uid === myUid);
});

// -------------------------------------
function renderPlayers() {
  const div = document.getElementById("playerList");
  div.innerHTML = "";

  Object.values(players).forEach(p => {
    const box = document.createElement("div");
    box.className = "playerBox";
    box.innerHTML = `
      <b>${p.nickname}</b><br>
      패: ${p.handCount}장<br>
      점수: ${p.score}
    `;
    div.append(box);
  });
}

function renderTable() {
  const div = document.getElementById("tableArea");
  div.innerHTML = "";
  if (tableCards.length === 0) {
    div.innerHTML = "<span style='color:#777'>(비어 있음)</span>";
    return;
  }
  tableCards.forEach(c => {
    div.append(drawScoutCard(c.top, c.bottom, 90, 130));
  });
}

function renderHand() {
  const div = document.getElementById("handArea");
  div.innerHTML = "";
  document.getElementById("myCount").innerText = myHand.length;

  myHand.forEach((card, idx) => {
    const useBottom = flipState[idx] === "bottom";
    const c = useBottom ? { top: card.bottom, bottom: card.top } : card;

    const wrap = document.createElement("div");
    wrap.className = "card-wrapper";

    if (selected.has(idx)) wrap.classList.add("selected");

    wrap.append(drawScoutCard(c.top, c.bottom));

    const flipBtn = document.createElement("div");
    flipBtn.className = "flip-btn";
    flipBtn.innerText = "↻";
    flipBtn.onclick = (e) => {
      e.stopPropagation();
      flipState[idx] = useBottom ? "top" : "bottom";
      renderHand();
    };
    wrap.append(flipBtn);

    wrap.onclick = () => {
      selected.has(idx)
        ? selected.delete(idx)
        : selected.add(idx);
      renderHand();
    };

    div.append(wrap);
  });
}

// -------------------------------------
// Buttons
// -------------------------------------
window.doShow = function () {
  if (!myTurn) return alert("turn 아님");

  const cards = [...selected].map(i => {
    const c = myHand[i];
    return flipState[i] === "bottom"
      ? { top: c.bottom, bottom: c.top }
      : c;
  });

  if (getComboType(cards) === "invalid")
    return alert("세트/런 아님");

  if (!isStrongerCombo(cards, tableCards))
    return alert("더 약함");

  socket.emit("show", { roomId, cards });

  selected.clear();
};

window.doScout = function () {
  if (!myTurn) return alert("turn 아님");
  if (tableCards.length !== 1) return alert("1장일 때만 스카우트");

  const c = tableCards[0];
  const choose = confirm(`bottom(${c.bottom})?`);
  const chosenValue = choose ? "bottom" : "top";

  socket.emit("scout", { roomId, chosenValue });
};

window.doPass = function () {
  if (!myTurn) return alert("turn 아님");
  socket.emit("pass", { roomId });
};
</script>

<body>

<h2 id="roundInfo">라운드 -</h2>

<div class="gameLayout">

  <div id="playerList" class="sidePanel"></div>

  <div class="mainPanel">
    <h3>테이블</h3>
    <div id="tableArea" class="tablePanel"></div>

    <h3>내 패 (<span id="myCount"></span>)</h3>
    <div id="handArea" class="handPanel"></div>

    <div class="buttonRow">
      <button onclick="doShow()">SHOW</button>
      <button onclick="doScout()">SCOUT</button>
      <button onclick="doPass()">PASS</button>
    </div>
  </div>

</div>

</body>
</html>
