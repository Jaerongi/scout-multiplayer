<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>SCOUT MULTIPLAYER</title>

<link rel="stylesheet" href="style.css" />
<script src="/socket.io/socket.io.js"></script>
<script type="module">

/* ============================================================
   IMPORTS
============================================================ */
import { drawScoutCard } from "./cardEngine.js";
import { getComboType, isStrongerCombo } from "./shared.js";

/* ============================================================
   URL PARAM
============================================================ */
const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const myName = params.get("name");

// â— lobby.html ì—†ìŒ â†’ start.htmlë¡œ ë˜ëŒë¦¬ê¸°
if (!roomId || !myName) {
  alert("ë°©ID ë˜ëŠ” ë‹‰ë„¤ì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
  location.href = "start.html";
}

/* ============================================================
   SOCKET INIT
============================================================ */
const socket = io();

/* ============================================================
   DOM ELEMENTS
============================================================ */
const playerListDiv = document.getElementById("playerList");
const tableAreaDiv = document.getElementById("tableArea");
const handAreaDiv = document.getElementById("handArea");
const myCountSpan = document.getElementById("myCount");
const roundInfo = document.getElementById("roundInfo");

const roundPopup = document.getElementById("roundPopup");
const popupRoundResult = document.getElementById("popupRoundResult");

const gameEndPopup = document.getElementById("gameEndPopup");
const popupFinalResult = document.getElementById("popupFinalResult");

/* ============================================================
   LOCAL STATE
============================================================ */
let myUid = null;
let players = {};
let tableCards = [];
let myHand = [];
let selected = new Set();
let flipState = {};
let myTurn = false;

/* ============================================================
   JOIN ROOM (ê²Œì„ í™”ë©´ ì§„ì…)
============================================================ */
socket.on("connect", () => {
  myUid = socket.id;
});

/* ============================================================
   SOCKET EVENTS
============================================================ */

// í”Œë ˆì´ì–´ ëª©ë¡
socket.on("playerListUpdate", (p) => {
  players = p;
  renderPlayerList();
});

// ë¼ìš´ë“œ ì‹œì‘
socket.on("roundStart", ({ round, players: p, startingPlayer }) => {
  players = p;
  tableCards = [];

  roundInfo.innerText = `ë¼ìš´ë“œ ${round}`;
  highlightTurn(startingPlayer);
  renderTable();
});

// ğŸ”¥ ë‚´ ì†íŒ¨ ì „ë‹¬
socket.on("yourHand", (handData) => {
  myHand = handData;
  selected.clear();
  flipState = {};
  renderHand();
});

// ì†íŒ¨ ê°œìˆ˜ ê°±ì‹ 
socket.on("handCountUpdate", (counts) => {
  for (const uid in players) {
    players[uid].handCount = counts[uid];
  }
  renderPlayerList();
});

// í…Œì´ë¸” ì¹´ë“œ ê°±ì‹ 
socket.on("tableUpdate", (cards) => {
  tableCards = cards;
  renderTable();
});

// í„´ ë³€ê²½
socket.on("turnChange", (uid) => {
  myTurn = uid === myUid;
  highlightTurn(uid);
});

// ì—ëŸ¬ ë©”ì‹œì§€
socket.on("errorMessage", (msg) => alert(msg));

// ë¼ìš´ë“œ ì¢…ë£Œ
socket.on("roundEnded", ({ winner, players }) => {
  popupRoundResult.innerHTML =
    `<b>${winner}</b> ë¼ìš´ë“œ ìŠ¹ë¦¬!<br><br>` +
    Object.values(players)
      .map(p => `${p.nickname}: ${p.score}`)
      .join("<br>");

  roundPopup.style.display = "block";
});

// ê²Œì„ ì¢…ë£Œ
socket.on("gameEnd", ({ players }) => {
  popupFinalResult.innerHTML =
    Object.values(players)
      .sort((a,b)=>b.score - a.score)
      .map((p,i)=>`${i+1}ë“±: ${p.nickname} (${p.score}ì )`)
      .join("<br>");

  gameEndPopup.style.display = "block";
});

/* ============================================================
   RENDER FUNCTIONS
============================================================ */
function renderPlayerList() {
  playerListDiv.innerHTML = "";

  Object.values(players).forEach((p) => {
    const div = document.createElement("div");
    div.className = "playerBox";

    if (p.uid === myUid) div.style.background = "#333";

    div.innerHTML = `
      <div class="name">${p.nickname}</div>
      <div class="score">ì ìˆ˜: ${p.score}</div>
      <div class="handCount">íŒ¨: ${p.handCount}ì¥</div>
    `;

    playerListDiv.appendChild(div);
  });
}

function highlightTurn(uid) {
  const boxes = playerListDiv.getElementsByClassName("playerBox");
  const list = Object.values(players);

  for (let i=0; i<boxes.length; i++) {
    if (list[i].uid === uid) boxes[i].classList.add("currentTurn");
    else boxes[i].classList.remove("currentTurn");
  }
}

function renderTable() {
  tableAreaDiv.innerHTML = "";

  if (tableCards.length === 0) {
    tableAreaDiv.innerHTML = "<span style='color:#888'>(ë¹„ì–´ ìˆìŒ)</span>";
    return;
  }

  tableCards.forEach((c) => {
    const cardEl = drawScoutCard(c.top, c.bottom, 90, 130);
    tableAreaDiv.appendChild(cardEl);
  });
}

function renderHand() {
  handAreaDiv.innerHTML = "";
  myCountSpan.innerText = myHand.length;

  myHand.forEach((card, idx) => {
    const useBottom = (flipState[idx] === "bottom");
    const c = useBottom
      ? { top: card.bottom, bottom: card.top }
      : card;

    const wrapper = document.createElement("div");
    wrapper.className = "card-wrapper";
    if (selected.has(idx)) wrapper.classList.add("selected");

    const canvas = drawScoutCard(c.top, c.bottom);
    wrapper.appendChild(canvas);

    // flip ë²„íŠ¼
    const flipBtn = document.createElement("div");
    flipBtn.className = "flip-btn";
    flipBtn.innerText = "â†»";
    flipBtn.onclick = (e) => {
      e.stopPropagation();
      flipState[idx] = useBottom ? "top" : "bottom";
      renderHand();
    };
    wrapper.appendChild(flipBtn);

    wrapper.onclick = () => {
      if (selected.has(idx)) selected.delete(idx);
      else selected.add(idx);
      renderHand();
    };

    handAreaDiv.appendChild(wrapper);
  });
}

/* ============================================================
   ACTION BUTTONS
============================================================ */

window.doShow = function () {
  if (!myTurn) return alert("ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤.");
  if (selected.size === 0) return alert("ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.");

  const selectedCards = [...selected].map(i => {
    const card = myHand[i];
    return flipState[i] === "bottom"
      ? { top: card.bottom, bottom: card.top }
      : { top: card.top, bottom: card.bottom };
  });

  if (getComboType(selectedCards) === "invalid")
    return alert("ì„¸íŠ¸ ë˜ëŠ” ëŸ°ì´ ì•„ë‹™ë‹ˆë‹¤.");

  if (!isStrongerCombo(selectedCards, tableCards))
    return alert("ê¸°ì¡´ í…Œì´ë¸”ë³´ë‹¤ ì•½í•©ë‹ˆë‹¤.");

  socket.emit("show", { roomId, cards: selectedCards });

  selected.clear();
  flipState = {};
};

window.doScout = function () {
  if (!myTurn) return alert("ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤.");
  if (tableCards.length !== 1)
    return alert("ìŠ¤ì¹´ìš°íŠ¸ëŠ” í…Œì´ë¸”ì— 1ì¥ì¼ ë•Œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

  const t = tableCards[0];
  const choose = confirm(
    `ìŠ¤ì¹´ìš°íŠ¸ ë°©í–¥ ì„ íƒ\ní™•ì¸: bottom(${t.bottom})\nì·¨ì†Œ: top(${t.top})`
  );

  const chosenValue = choose ? "bottom" : "top";

  socket.emit("scout", { roomId, chosenValue });

  selected.clear();
};

window.doPass = function () {
  if (!myTurn) return alert("ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤.");
  socket.emit("pass", { roomId });
};

/* ============================================================
   POPUP
============================================================ */
window.closeRoundPopup = function () {
  roundPopup.style.display = "none";
};

</script>
</head>

<body>

<div id="topBar">
  <div id="roundInfo">ë¼ìš´ë“œ -</div>
</div>

<div id="playerList"></div>

<h2>í…Œì´ë¸”</h2>
<div id="tableArea"></div>

<h2>ë‚´ íŒ¨ (<span id="myCount"></span>ì¥)</h2>
<div id="handArea"></div>

<div id="actionArea">
  <button onclick="doShow()">SHOW</button>
  <button onclick="doScout()">SCOUT</button>
  <button onclick="doPass()">PASS</button>
</div>

<!-- ë¼ìš´ë“œ ì¢…ë£Œ -->
<div id="roundPopup" class="popup">
  <h2>ë¼ìš´ë“œ ì¢…ë£Œ</h2>
  <div id="popupRoundResult"></div>
  <button onclick="closeRoundPopup()">í™•ì¸</button>
</div>

<!-- ê²Œì„ ì¢…ë£Œ -->
<div id="gameEndPopup" class="popup">
  <h2>ê²Œì„ ì¢…ë£Œ</h2>
  <div id="popupFinalResult"></div>
</div>

</body>
</html>

